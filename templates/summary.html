{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrapped Summary</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'main.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Centered Slideshow Playlist Style */
        .main-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            /*background: linear-gradient(30deg, #A5CBC3 20%, #FFFFFF 100%);*/
        }
        .slideshow-container {
            position: relative;
            width: 1000px;
            height: 550px;
            text-align: left;
            /*border: 1px solid var(--light-background);*/
            border-radius: 10px;
            /*padding: 20px;*/
            /*box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);*/
            margin-bottom: 20px;
            /*background: var(--light-background);*/
        }
        .slide {
            position: absolute;
            display: none;
            padding: 20px;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            text-align: left;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            background: var(--light-background);
        }
        .slide.active {
            display: block;
        }
        .slide img {
            max-width: 50%;
            height: auto;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .slide h2 {
            font-family: 'DM Sans', sans-serif;
            color: #1E1E1E;
            font-size: 64px;
            line-height: 1.1;
            margin-top: 30px;
            margin-left: 70px;
            margin-right: 50px;
        }
        .slide h3 {
            font-family: 'DM Sans', sans-serif;
            color: #3F665E;
            font-size: 48px;
            line-height: 1.1;
            margin-top: 30px;
            margin-left: 70px;
            margin-right: 50px;
        }
        .slide h4 {
            font-family: 'DM Sans', sans-serif;
            color: #3F665E;
            font-size: 36px;
            line-height: 0.8;
            margin-top: 30px;
            margin-left: 70px;
            margin-right: 50px;
        }

        .slide h5 {
            font-family: 'DM Sans', sans-serif;
            color: #3F665E;
            font-size: 36px;
            line-height: 0.8;
            margin-top: 30px;
            margin-right: 50px;
        }

        .slide h6 {
            font-family: 'DM Sans', sans-serif;
            color: #3F665E;
            font-size: 48px;
            line-height: 1.1;
            margin-left: 70px;
            margin-right: 50px;
        }

        .slide h7 {
            font-family: 'DM Sans', sans-serif;
            color: #3F665E;
            font-size: 24px;
            line-height: 1.1;
            margin: 30px;
        }

        .slide p {
            color: #3F665E;
            font-size: 18px;
            margin-top: 5px;
            margin-left: 70px;
            margin-right: 50px;
        }

        .slide p1 {
            color: #3F665E;
            font-size: 14px;
            margin-top: 5px;
            font-weight: bold;
        }


        .icon-container {
            width: 120%;
            height: 90px; /* Adjust as needed for cropping */
            overflow: hidden;
            margin-top: 50px;
            display: flex;
            justify-content: left;
            align-items: center;
        }

        .intro-icon {
            width: auto; /* Adjust width/height as needed */
            height: 100%;
            object-fit: cover;
            margin: 0;
        }

        .artist-info {
            display: flex; /* Align items in a row */
            align-items: center; /* Center items vertically */
        }

        .artist-stats {
            margin-right: 20px; /* Space between text and stats */
            text-align: left; /* Center text and photo horizontally */
            display: flex;
            flex-direction: column; /* Stack name and photo vertically */
        }

        .artist-details {
            margin-right: 20px; /* Space between text and stats */
            text-align: center; /* Center text and photo horizontally */
            display: flex;
            flex-direction: column; /* Stack name and photo vertically */
        }

        .top-artist-photo {
            width: 150px; /* Adjust width as needed */
            height: auto; /* Maintain aspect ratio */
            margin-left: 70px;
        }


        .song-info {
            display: flex; /* Align items in a row */
            align-items: center; /* Center items vertically */
            width: 800px;
            margin-right: 30px;
        }

        .song-stats {
            text-align: left; /* Center text and photo horizontally */
            display: flex;
            flex-direction: column; /* Stack name and photo vertically */
            margin-right: 70px;
        }


        .song-details1 {
            align-items: center;
            display: flex;
            flex-direction: column; /* Stack name and photo vertically */
            justify-content: center; /* Center items vertically */
        }

        .top-song-photo {
            width: 150px; /* Adjust width as needed */
            height: auto; /* Maintain aspect ratio */
        }

        .vibes-details {
            margin-right: 20px; /* Space between text and stats */
            text-align: left; /* Center text and photo horizontally */
            display: flex;
            flex-direction: column; /* Stack name and photo vertically */
        }

        .other-icon-container {
            width: 100%;
            height: 90px; /* Adjust as needed for cropping */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .other-icon {
            width: auto; /* Adjust width/height as needed */
            height: 100px;
            object-fit: cover;
        }



        .artist-container {
            display: flex;
            justify-content: center; /* Center all artist items within the container */
            flex-wrap: nowrap; /* Prevent items from wrapping to the next line */
            margin-left: 30px;
            margin-right: 30px;
        }

        .artist {
            display: flex; /* Use flexbox to align items */
            flex-direction: column; /* Stack text and image vertically */
            align-items: center; /* Center items horizontally */
            margin: 5px; /* Adjust spacing between artists */
        }

        .artist-photo {
            width: 100%;
            height: auto;
            margin-top: 15px; /* Space between the image and the text */
            display: block; /* Ensure that the image is a block element */
            margin-left: auto; /* Center alignment */
            margin-right: auto; /* Center alignment */
        }


        .song-container {
            display: flex;
            justify-content: center; /* Center all artist items within the container */
            flex-wrap: nowrap; /* Prevent items from wrapping to the next line */
            margin-left: 30px;
            margin-right: 30px;
        }

        .song {
            display: flex; /* Use flexbox to align items */
            flex-direction: column; /* Stack text and image vertically */
            align-items: center; /* Center items horizontally */
            margin: 5px; /* Adjust spacing between artists */
        }

        .song-photo {
            width: 100%;
            height: auto;
            margin-top: 15px; /* Space between the image and the text */
            display: block; /* Ensure that the image is a block element */
            margin-left: auto; /* Center alignment */
            margin-right: auto; /* Center alignment */
        }


        .glance-info {
            display: flex; /* Align items in a row */
            align-items: center; /* Center items vertically */
            margin: 0;
        }

        .glance-details {
            margin-right: 10px; /* Space between text and stats */
            text-align: center; /* Center text and photo horizontally */
            display: flex;
            flex-direction: column; /* Stack name and photo vertically */
        }

        .slide.quiz {
            /*background: var(--primary-green);*/
        }

        .quiz-options p {
            font-size: 24px;
            transition: transform 0.05s ease-in-out; /* Smooth transition */
        }

        .quiz-options p:hover {
            transform: translate(10px, 0px);
            font-weight: bold;
        }

        .quiz-options p.selected {
            background-color: var(--primary-green-dark); /* Green */
            color: white;
            padding: 5px;
            border-radius: 5px;
        }

        .quiz-options p.incorrect {
            background-color: #a2455e;
            color: white;
            padding: 5px;
            border-radius: 5px;
        }

        /* Dots and Arrow Button Styling */
        .dots-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .prev, .next {
            cursor: pointer;
            padding: 10px;
            color: #FFFFFF;
            font-weight: bold;
            font-size: 18px;
            user-select: none;
            border-radius: 50%;
            background-color: #3F665E;
            margin: 0 10px;
        }

        body.dark-mode .prev, .next {
            background-color: #576385;
        }
        .prev:hover, .next:hover {
            background-color: #1E1E1E;
        }
        .dots {
            display: flex;
            justify-content: center;
        }
        .dot {
            height: 12px;
            width: 12px;
            margin: 0 5px;
            background-color: white;
            border-radius: 50%;
            display: inline-block;
            cursor: pointer;
        }
        .dot.active {
            background-color: #3F665E;
        }

        /* Slide In & Out Animation */
        @keyframes slide-out-left {
            0% {
                transform: translate(0, 0) scale(1);
                z-index: 2;
            }
            49% {
                z-index: 2; /* Outgoing slide stays on top until halfway */
            }
            50% {
                transform: translate(-400px, 0) scale(0.9);
                z-index: 1;
            }
            100% {
                transform: translate(0, 0) scale(0.8);
                z-index: 1;
                opacity: 0;
            }
        }
        @keyframes slide-in-right {
            0% {
                transform: translate(0, 0) scale(0.8);
                z-index: 1;
            }
            49% {
                z-index: 1; /* Incoming slide below outgoing slide initially */
            }
            50% {
                transform: translate(400px, 0) scale(0.9);
                z-index: 2;
            }
            100% {
                transform: translate(0, 0) scale(1);
                z-index: 2;
            }
        }
        @keyframes slide-out-right {
            0% {
                transform: translate(0, 0) scale(1);
                z-index: 2;
            }
            49% {
                z-index: 2;
            }
            50% {
                transform: translate(400px, 0) scale(0.9);
                z-index: 1;
            }
            100% {
                transform: translate(0, 0) scale(0.8);
                z-index: 1;
                opacity: 0;
            }
        }
        @keyframes slide-in-left {
            0% {
                transform: translate(0, 0) scale(0.8);
                z-index: 1;
            }
            49% {
                z-index: 1;
            }
            50% {
                transform: translate(-400px, 0) scale(0.9);
                z-index: 2;
            }
            100% {
                transform: translate(0, 0) scale(1);
                z-index: 2;
            }
        }
        .outgoing-left {
            animation: slide-out-left 1.5s ease-in-out forwards;
        }

        .incoming-right {
            animation: slide-in-right 1.5s ease-in-out forwards;
        }

        .outgoing-right {
            animation: slide-out-right 1.5s ease-in-out forwards;
        }

        .incoming-left {
            animation: slide-in-left 1.5s ease-in-out forwards;
        }
    </style>
</head>
<body>
    <!-- Header and Navbar -->
    <header>
        <nav class="navbar">
            <a href="{% url 'dashboard' %}">Dashboard</a>
            <a href="{% url 'account_settings' %}">Account</a>
            <a href="#" class="btn" data-bs-toggle="modal" data-bs-target="#logoutModal">Log Out</a>
        </nav>
    </header>

    <!-- Main Content Area for Centered Slideshow -->
    <div class="main-content">
        <div id="slideshow-container" class="slideshow-container">

            <!-- Slide 1 -->
            <div class="slide active">
                <h2>{{user_name}}, are you ready to explore your musical soul?</h2>
                <p class="intro-text">Your musical journey awaits—discover your top tracks, artists, and genres.</p>
                <div class="icon-container">
                    <img src="{% static 'sound-icon.png' %}" alt="sound waves" class="intro-icon">
                </div>
            </div>

            <!-- Quiz Q1 -->
            <div class="slide quiz">
                <h2>Pop Quiz!</h2>
                <h3>Who's your top artist?</h3>
                <div class="quiz-options">
                    <p class="quiz-options" data-correct="false">a) {{ top_five_artists.4.name }}</p>
                    <p class="quiz-options" data-correct="true">b) {{ top_five_artists.0.name }}</p>
                    <p class="quiz-options" data-correct="false">c) {{ top_five_artists.1.name }}</p>
                    <p class="quiz-options" data-correct="false">d) {{ top_five_artists.2.name }}</p>
                </div>
            </div>

            <!-- Slide 2 -->
            <div class="slide">
                <h2>Your top artist is...</h2>
                <div class="artist-info">
                    <div class="artist-details">
                        <h3>{{ top_five_artists.0.name }}</h3>
                        <img src="{{ top_five_artists.0.image_url }}" alt="top artist image" class="top-artist-photo">
                    </div>
                    <div class="artist-stats">
                        <h4>Genre: {{ top_five_artists.0.genres|join:", " }}</h4> <!-- the join gets rid of the [' '] -->
                        <h4>Popularity: {{ top_five_artists.0.popularity }}</h4>
<!--                        <h4>Top Songs: </h4>-->
                    </div>
                </div>
            </div>

            <!-- Slide 3 -->
            <div class="slide">
                <h2>Your top 5 artists are...</h2>
                <div class="artist-container">
                    {% for artist in top_five_artists %}
                        <div class="artist">
                            <p1>#{{ forloop.counter }}. {{ artist.name }}</p1>
                            <img src="{{ artist.image_url }}" alt="artist image" class="artist-photo">
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Quiz Q2 -->
            <div class="slide quiz">
                <h2>Pop Quiz!</h2>
                <h3>Which is your top song?</h3>
                <div class="quiz-options">
                    <p class="quiz-options" data-correct="false">a) {{ top_five_songs.4.name }}</p>
                    <p class="quiz-options" data-correct="true">b) {{ top_five_songs.0.name }}</p>
                    <p class="quiz-options" data-correct="false">c) {{ top_five_songs.1.name }}</p>
                    <p class="quiz-options" data-correct="false">d) {{ top_five_songs.2.name }}</p>
                </div>
            </div>

            <!-- Slide 4 -->
            <div class="slide">
                <h2>Your top song is...</h2>
                <div class="song-info">
                    <div class="song-details1" style="display: flex; flex-direction: column; align-items: center;">
                        <h6>{{ top_five_songs.0.name }}</h6>
                        <img src="{{ top_five_songs.0.image_url }}" alt="top song image" class="top-song-photo">
                        {% if top_five_songs.0.preview_url %}
                            <audio id="audio-top-song">
                                <source src="{{ top_five_songs.0.preview_url }}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                            <!-- Play/pause btn -->
                            <button class="play-pause-button btn btn-primary mt-2" data-audio-id="audio-top-song">
                                ▶
                            </button>
                        {% else %}
                            <p class="text-muted">No preview available</p>
                        {% endif %}
                        <div class="other-icon-container">
<!--                            <img src="{% static 'playback icon.png' %}" alt="playback" class="other-icon">-->
                        </div>
                    </div>
                    <div class="song-stats">
                        <h5>Popularity: {{ top_five_songs.0.popularity }}</h5>
<!--                        <h5>Dance Vibes: {{ top_five_songs.0.average_danceability }}</h5>-->
                    </div>
                </div>
            </div>

            <!-- Slide 5 -->
            <div class="slide">
                <h2>Your top 5 songs are...</h2>
                <div class="song-container">
                    {% for song in top_five_songs %}
                        <div class="song">
                            <p1>#{{ forloop.counter }}. {{ song.name }}</p1>
                            <img src="{{ song.image_url }}" alt="song image" class="song-photo">
                            {% if song.preview_url %}
                                <!-- Hidden Audio Element -->
                                <audio id="audio-{{ forloop.counter }}">
                                    <source src="{{ song.preview_url }}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                                <!-- Play/Pause Button -->
                                <button class="play-pause-button btn btn-primary mt-2" data-audio-id="audio-{{ forloop.counter }}">
                                    Play
                                </button>
                            {% else %}
                                <p class="text-muted">No preview available</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Slide 6 -->
            <div class="slide">
                <h2>Your top 5 genres are...</h2>
                <div class="artist-container">
                    {% for genre, count in top_genres.items %}
                        <div class="artist">
                            <p1>#{{ forloop.counter }}. {{ genre }}</p1>
                            <p>Count: {{ count }}</p> <!-- Display how often each genre appears -->
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Slide 7 -->
            <div class="slide">
                <h2>Your vibe data...</h2>
                <div class="artist-info">
                    <div class="vibes-details">
                        <h4>Danceability: {{ vibe_data.average_danceability|floatformat:2 }}%</h4>
                        <h4>Valence: {{ vibe_data.average_valence|floatformat:2 }}%</h4>
                        <h4>Energy: {{ vibe_data.average_energy|floatformat:2 }}%</h4>
                    </div>
                </div>
            </div>

            <!-- Slide 8 -->
            <div class="slide">
                <h3>Your Musical Soul at a Glance...</h3>
                <div class="glance-info">
                    <div class="glance-details">
                        <h7>Top Artist: {{top_five_artists.0.name}} </h7>
                        <img src="{{ top_five_artists.0.image_url }}" alt="top artist image" class="artist-photo">
                    </div>
                    <div class="glance-details">
                        <h7>Top Song: {{top_five_songs.0.name}} </h7>
                        <img src="{{ top_five_artists.1.image_url }}" alt="top artist image" class="artist-photo">
                    </div>
                    <div class="glance-details">
                        <h7>Top Genre: {{top_1_genre}} </h7>
                        <img src="{{ top_five_artists.2.image_url }}" alt="top artist image" class="artist-photo">
                    </div>
                </div>
                <div style="text-align: center; margin-top: 50px;">
                    {% if is_saved %}
                        <div style="text-align: center; margin-top: 50px;">
                        <form method="post" action="{% url 'history' %}">
                            {% csrf_token %}
                            <button type="submit" style="padding: 10px 20px; background-color: #3F665E; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Return to History
                            </button>
                        </form>
                        </div>
                    {% else %}
                        <form method="post" action="{% url 'save_spotify_profile' %}">
                        {% csrf_token %}
                        <input type="hidden" name="temporary_profile_id" value="{{ temp_profile_id }}">
                        <button type="submit" style="padding: 10px 20px; background-color: #3F665E; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Save this Profile
                        </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="dots-container">
            <a class="prev" onclick="changeSlide(-1)">&#10094;</a>
            <div class="dots">
                <span class="dot active" onclick="currentSlide(0)"></span>
                <span class="dot" onclick="currentSlide(1)"></span>
                <span class="dot" onclick="currentSlide(2)"></span>
                <span class="dot" onclick="currentSlide(3)"></span>
                <span class="dot" onclick="currentSlide(4)"></span>
                <span class="dot" onclick="currentSlide(5)"></span>
                <span class="dot" onclick="currentSlide(6)"></span>
                <span class="dot" onclick="currentSlide(7)"></span>
                <span class="dot" onclick="currentSlide(8)"></span>
                <span class="dot" onclick="currentSlide(9)"></span>
            </div>
            <a class="next" onclick="changeSlide(1)">&#10095;</a>
        </div>
    </div>

    <script>
        let slideIndex = 0; // curr index
        const slides = document.querySelectorAll('.slide');
        const dots = document.querySelectorAll('.dot');
        const animationDuration = 1500; // Duration in ms matching CSS animation

        /**
         * This function finds and displays in the new slide
         * @param newIndex The new index of the slide we are displaying
         * @param direction Either next or before, depending on which arrow was clicked
         */
        function showSlide(newIndex, direction) {
            const outgoingSlide = slides[slideIndex];
            const incomingSlide = slides[newIndex];

            // Reset all slides to remove animations and hide them initially
            slides.forEach(slide => {
                slide.classList.remove('active', 'outgoing-left', 'incoming-right', 'outgoing-right', 'incoming-left');
                slide.style.display = 'none';
            });

            // Ensure the outgoing slide is visible before animating out
            outgoingSlide.style.display = 'block';
            outgoingSlide.style.zIndex = 2; // Set outgoing slide behind incoming

            // Apply the correct animation classes based on direction
            if (direction === 'next') {
                outgoingSlide.classList.add('outgoing-left');
                incomingSlide.classList.add('incoming-right');
            } else {
                outgoingSlide.classList.add('outgoing-right');
                incomingSlide.classList.add('incoming-left');
            }

            // Ensure the incoming slide is above the outgoing slide and visible
            incomingSlide.style.display = 'block';
            incomingSlide.style.zIndex = 1;
            incomingSlide.classList.add('active');

            // Update dot navigation
            dots.forEach(dot => dot.classList.remove('active'));
            dots[newIndex].classList.add('active');

            // Hide the outgoing slide after the animation completes
            setTimeout(() => {
                // outgoingSlide.style.display = 'none'; // Hide the outgoing slide
                slideIndex = newIndex; // Update slideIndex after the transition completes
            }, animationDuration);
        }

        /**
         * This function changes the slide given an amount to move
         * @param n The amount we want to move
         */
        function changeSlide(n) {
            const newSlideIndex = (slideIndex + n + slides.length) % slides.length;
            const direction = n > 0 ? 'next' : 'prev';
            showSlide(newSlideIndex, direction);
        }

        /**
         * This function displays the current slide
         * @param index The index of the current slide
         */
        function currentSlide(index) {
            const direction = index > slideIndex ? 'next' : 'prev';
            showSlide(index, direction);
        }

        // Initial display
        showSlide(slideIndex, 'next');

        document.addEventListener('DOMContentLoaded', function () {
            const slideshowContainer = document.getElementById('slideshow-container');
            const quizOptions = document.querySelectorAll('.quiz-options p');

            /**
             * This function updates the link to not work if not on wrapped summary
             */
            function updateLink() {
                const activeSlide = document.querySelector('.slide.active');
                if (activeSlide && activeSlide.querySelector('h2').innerText === 'Wrapped Summary') {
                    slideshowContainer.onclick = () => {
                        window.location.href = "{% url 'spotify_login' %}";
                    };
                } else {
                    slideshowContainer.onclick = null; // Remove click event if not on "Wrapped Summary"
                }
            }

            /**
             * Handles the quiz option click.
             * @param event The click of the user
             */
            function handleQuizOptionClick(event) {
                const selectedOption = event.target;

                // Disable further clicks on all options
                // const allOptions = selectedOption.parentNode.querySelectorAll('p');
                // allOptions.forEach(option => option.style.pointerEvents = 'none');


                if (selectedOption.dataset.correct === 'true') {
                    // Highlight the correct answer
                    selectedOption.classList.add('selected');
                    /*setTimeout(() => {
                        // Transition to the next slide
                        changeSlide(1); // Move to the next slide
                    }, 500); // Wait for feedback before sliding*/
                } else {
                    // Highlight incorrect answer
                    selectedOption.classList.add('incorrect');
                }
            }
            /**
             * Adds event listeners to quiz options.
             */
            quizOptions.forEach(option => {
                option.addEventListener('click', handleQuizOptionClick);
            });



            // Set up a MutationObserver to detect class changes in slides
            const observer = new MutationObserver(updateLink);
            slides.forEach(slide => observer.observe(slide, { attributes: true, attributeFilter: ['class'] }));

            // Initial link setup
            updateLink();
        });
    </script>

<!-- Log Out Confirmation Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h5 class="modal-title" id="logoutModalLabel">Confirm Log Out</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!-- Modal Body -->
            <div class="modal-body">
                Are you sure you want to log out?
            </div>
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="{% url 'signout' %}" class="btn btn-primary">Log Out</a>
            </div>
        </div>
    </div>
</div>

<!-- jQuery (Optional for Bootstrap 5, but required if you use any jQuery plugins) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap JavaScript Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="{% static 'darkmode.js' %}"></script>
<script src="{% static 'summary.js' %}"></script>

</body>
</html>